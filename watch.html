<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reproductor - MangaZen</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: '#8c25f4' } } } }
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* Bloquear todo scroll y rebote en m칩vil */
        body { background-color: #000; overflow: hidden; margin: 0; overscroll-behavior: none; touch-action: none; }
        
        #main-container {
            position: relative; 
            width: 100vw; 
            height: 100dvh; /* Altura din치mica real del m칩vil */
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: black; 
            /* Importante: Separa el contenido de la barra de gestos inferior */
            padding-bottom: env(safe-area-inset-bottom, 40px); 
        }

        video {
            width: 100%; height: 100%; object-fit: contain;
            transition: object-fit 0.3s ease, filter 0.2s ease; outline: none;
        }

        /* 游뛂 OCULTAR BOTONES NATIVOS QUE ROMPEN LA UI EN M칍VIL */
        video::-webkit-media-controls-fullscreen-button { display: none !important; }
        
        /* Fondo m치s oscuro para los controles nativos para que se vean */
        video::-webkit-media-controls-panel { background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); }
        
        /* Botones Flotantes (M치s oscuros y visibles) */
        .player-btn {
            background: rgba(0, 0, 0, 0.7); /* Fondo m치s oscuro para contraste */
            backdrop-filter: blur(8px);
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; width: 50px; height: 50px; /* M치s grandes para el dedo */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); /* Sombra para resaltar */
        }
        .player-btn:active { transform: scale(0.9); background: rgba(140, 37, 244, 0.8); }

        /* Posiciones: M치s separadas de los bordes para evitar toques falsos */
        #btn-back { position: absolute; top: 40px; left: 30px; z-index: 50; width: auto; padding: 0 16px; border-radius: 30px; gap: 8px; }
        
        .tools-group {
            position: absolute; top: 40px; right: 30px;
            display: flex; flex-direction: column; gap: 20px; z-index: 50;
        }

        /* Panel EQ (Mejorado para m칩vil) */
        #eq-panel {
            position: absolute; top: 100px; right: 80px; width: 240px;
            background: rgba(10, 10, 10, 0.98); /* Casi negro s칩lido */
            border: 1px solid rgba(140, 37, 244, 0.5); border-radius: 16px;
            padding: 16px; color: white; z-index: 60; display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }

        /* Sliders m치s gordos para facilitar el toque */
        input[type=range] { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; margin-top: 10px; margin-bottom: 10px; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #8c25f4; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px black; }

        .hidden { display: none !important; }
    </style>
</head>

<body>

    <div id="main-container">
        
        <button id="btn-back" class="player-btn" onclick="history.back()">
            <span class="material-symbols-outlined">arrow_back</span>
            <span class="font-bold text-sm hidden md:block">Volver</span>
        </button>

        <div class="tools-group">
            <button id="btn-fullscreen" class="player-btn" onclick="toggleCustomFullscreen()">
                <span class="material-symbols-outlined" id="icon-fullscreen">fullscreen</span>
            </button>
            <button id="btn-zoom" class="player-btn" onclick="toggleAspectRatio()">
                <span class="material-symbols-outlined" id="icon-zoom">aspect_ratio</span>
            </button>
            <button id="btn-color" class="player-btn" onclick="toggleEqPanel()">
                <span class="material-symbols-outlined">tune</span>
            </button>
        </div>

        <div id="eq-panel">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <h3 class="text-sm font-bold text-white">Ajustes de Imagen</h3>
                <button onclick="resetFilters()" class="text-xs text-brand underline">Reset</button>
            </div>
            <div><span class="text-xs font-bold text-gray-400">Brillo</span> <input type="range" id="rng-brightness" min="50" max="150" value="100" oninput="applyFilters()"></div>
            <div><span class="text-xs font-bold text-gray-400">Contraste</span> <input type="range" id="rng-contrast" min="50" max="200" value="100" oninput="applyFilters()"></div>
            <div><span class="text-xs font-bold text-gray-400">Saturaci칩n (Color)</span> <input type="range" id="rng-saturate" min="0" max="250" value="100" oninput="applyFilters()"></div>
        </div>

        <video id="video-player" controls autoplay playsinline webkit-playsinline></video>

        <div id="toast-msg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 px-6 py-3 rounded-full text-white font-bold opacity-0 transition-opacity pointer-events-none z-[100]"></div>
    </div>

    <script>
        const video = document.getElementById('video-player');
        const container = document.getElementById('main-container');

        // --- 1. FULLSCREEN INTELIGENTE PARA M칍VIL ---
        function toggleCustomFullscreen() {
            // Intentamos la API est치ndar primero
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen(); // Safari Mobile
                } else if (video.webkitEnterFullscreen) {
                    // 칔LTIMO RECURSO (iPhone viejo): Esto romper치 los filtros, pero es mejor que nada.
                    // Idealmente, en iOS moderno, 'playsinline' + CSS 100dvh ya se siente como fullscreen.
                    video.webkitEnterFullscreen();
                    return; 
                }
                document.getElementById('icon-fullscreen').innerText = 'fullscreen_exit';
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                document.getElementById('icon-fullscreen').innerText = 'fullscreen';
            }
        }

        // --- 2. FILTROS (EQ) ---
        let filters = { b: 100, c: 100, s: 100 };
        const eqPanel = document.getElementById('eq-panel');

        function toggleEqPanel() {
            const isHidden = getComputedStyle(eqPanel).display === 'none';
            eqPanel.style.display = isHidden ? 'block' : 'none';
        }

        function applyFilters() {
            filters.b = document.getElementById('rng-brightness').value;
            filters.c = document.getElementById('rng-contrast').value;
            filters.s = document.getElementById('rng-saturate').value;
            // Aplicamos filtro. NOTA: En iPhone, si se abre el reproductor nativo, esto se ignorar치.
            // Por eso es vital usar el bot칩n de fullscreen personalizado de arriba.
            video.style.filter = `brightness(${filters.b}%) contrast(${filters.c}%) saturate(${filters.s}%)`;
        }

        function resetFilters() {
            document.getElementById('rng-brightness').value = 100;
            document.getElementById('rng-contrast').value = 100;
            document.getElementById('rng-saturate').value = 100;
            applyFilters();
            showToast('Imagen Restablecida');
        }

        // --- 3. ZOOM ---
        const modes = ['contain', 'cover', 'fill'];
        const modeNames = ['Original', 'Zoom (Llenar Pantalla)', 'Estirado'];
        let currentMode = 0;

        function toggleAspectRatio() {
            currentMode = (currentMode + 1) % modes.length;
            video.style.objectFit = modes[currentMode];
            showToast(modeNames[currentMode]);
        }

        function showToast(msg) {
            const t = document.getElementById('toast-msg');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        // Ocultar UI al no tocar
        let uiTimer;
        container.addEventListener('touchstart', () => {
            document.querySelectorAll('.player-btn, .tools-group').forEach(el => el.style.opacity = '1');
            clearTimeout(uiTimer);
            uiTimer = setTimeout(() => {
                if (!video.paused && getComputedStyle(eqPanel).display === 'none') {
                    document.querySelectorAll('.player-btn, .tools-group').forEach(el => el.style.opacity = '0');
                }
            }, 4000); // 4 segundos en m칩vil
        });

    </script>
    <script type="module" src="./js/watch-logic.js"></script>
</body>
</html>